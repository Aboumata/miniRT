# الدليل الشامل لمشروع miniRT (تتبع الأشعة - Ray Tracing)

هذا المستند يشرح الأسس الرياضية والخوارزميات المستخدمة في بناء محرك تتبع الأشعة (Ray Tracer) الخاص بك.

---

## 1. مبدأ عمل تتبع الأشعة (Ray Tracing Basics)

الفكرة الأساسية هي محاكاة كيفية انتقال الضوء في العالم الحقيقي ولكن بشكل عكسي. بدلاً من تتبع مليارات الفوتونات من مصدر الضوء، نطلق "شعاعاً" (Ray) من "عين الكاميرا" عبر كل "بكسل" في الشاشة ونرى ماذا يصطدم به.

### معادلة الشعاع (The Ray Equation)
أي شعاع في الفضاء ثلاثي الأبعاد يمكن تمثيله بالمعادلة الخطية التالية:
P(t) = O + t * D

حيث:
- P(t): النقطة على الشعاع عند المسافة t.
- O: نقطة الأصل (Origin) - عادة مكان الكاميرا.
- D: اتجاه الشعاع (Direction) - متجه وحدة (Normalized Vector).
- t: عدد حقيقي يمثل المسافة من نقطة الأصل.

---

## 2. الكاميرا (Camera)

لتحويل المشهد ثلاثي الأبعاد إلى صورة ثنائية الأبعاد، نستخدم نموذج "الكاميرا ذات الثقب" (Pinhole Camera).

**كيفية توليد الأشعة:**
1. نحدد أبعاد "نافذة العرض" (Viewport) بناءً على زاوية الرؤية (FOV).
2. لكل بكسل (x, y) في الصورة، نحسب إحداثياته في الفضاء ثلاثي الأبعاد.
3. اتجاه الشعاع يكون:
D = normalize(PixelPosition - CameraPosition)

---

## 3. تقاطع الأشكال (Intersections)

لمعرفة ما يراه الشعاع، نحل معادلات رياضية للبحث عن قيمة t التي تحقق معادلة الشكل.

### أ. الكرة (Sphere)
معادلة الكرة هي:
(P - C) * (P - C) = r^2
حيث C هو المركز و r هو نصف القطر.
بتعويض معادلة الشعاع P(t) في معادلة الكرة، نحصل على معادلة تربيعية:
a * t^2 + b * t + c = 0

حيث:
- L = O - C (المتجه من المركز للكاميرا)
- a = D * D (يساوي 1 إذا كان المتجه موحداً)
- b = 2 * (L * D)
- c = (L * L) - r^2

نحسب المميز (Delta = b^2 - 4ac). إذا كان موجباً، يوجد حلان (تقاطعان)، نأخذ الأقرب (الأصغر الموجب).

### ب. المستوى (Plane)
المستوى معرف بنقطة P0 ومتجه عمودي N.
المعادلة:
(P - P0) * N = 0
الحل لإيجاد t:
t = ((P0 - O) * N) / (D * N)

إذا كان المقام (D * N) قريباً من الصفر، فالشعاع يوازي المستوى ولا يقطعه.

### ج. الأسطوانة (Cylinder)
الأسطوانة أصعب قليلاً لأنها ممتدة لا نهائياً في معادلتها الأساسية، ثم نقطعها بالطول.
نعتمد على حقيقة أن المسافة من أي نقطة على السطح إلى المحور تساوي نصف القطر r.

المعادلة التربيعية للأسطوانة (باستبعاد المحور $Y$ أو محور الدوران):
- نحسب المتجهات المتعامدة مع محور الأسطوانة.
- نحل المعادلة التربيعية a * t^2 + b * t + c = 0 مشابهة للكرة ولكن في بعدين فقط (حول المحور).
- بعد إيجاد t، يجب التحقق مما إذا كانت نقطة التقاطع تقع ضمن "ارتفاع" الأسطوانة (height).
- **الأغطية (Caps):** نتعامل معها كتقاطع مع مستويين (Plane) دائريين عند القمة والقاعدة.

---

## 4. الإضاءة والظلال (Lighting & Shadows)

نستخدم نموذج **Phong Reflection Model** لحساب لون النقطة.

Color = Ambient + Diffuse + Specular

### 1. الإضاءة المحيطة (Ambient)
ضوء ثابت يغطي كل المشهد لضمان عدم وجود سواد تام.
Ambient = Ka * Color

### 2. الإضاءة المنتشرة (Diffuse)
تحاكي الأسطح غير اللامعة. تعتمد على الزاوية بين "العمودي على السطح" (N) و "اتجاه الضوء" (L).
Diffuse = Kd * (N * L) * LightColor
إذا كانت الزاوية أكبر من 90 درجة (الضرب النقطي سالب)، فالضوء لا يضرب السطح.

### 3. اللمعان (Specular)
يحاكي انعكاس الضوء المباشر (النقطة البيضاء اللامعة). يعتمد على الزاوية بين "اتجاه الانعكاس" (R) و "اتجاه النظر" (V).
Specular = Ks * (R * V)^alpha * LightColor
حيث alpha هي معامل اللمعان (Shininess).

### 4. الظلال (Shadows)
لمعرفة ما إذا كانت النقطة في الظل:
1. نطلق "شعاع ظل" (Shadow Ray) من نقطة التقاطع نحو مصدر الضوء.
2. إذا اصطدم هذا الشعاع بأي جسم قبل وصوله للضوء، فالنقطة في الظل.
3. في الظل، نحسب فقط الـ Ambient.

---

## 5. الخامات والـ UV Mapping

هنا نأتي للجزء الممتع: كيف نضع صورة (Texture) على شكل ثلاثي الأبعاد؟

### ما هو الـ UV؟
الـ UV هي إحداثيات ثنائية الأبعاد (u, v) تتراوح عادة بين 0 و 1.
- **U**: المحور الأفقي للصورة.
- **V**: المحور الرأسي للصورة.

الهدف هو تحويل نقطة ثلاثية الأبعاد (x, y, z) على سطح الشكل إلى نقطة ثنائية الأبعاد (u, v) لنعرف أي لون نأخذه من الصورة.

### حساب الـ UV لكل شكل:

#### 1. الكرة (Spherical Mapping)
نستخدم الإحداثيات الكروية (خطوط الطول والعرض).
- نحسب الزاوية حول المحور Y (Azimuth) -> تعطينا u.
- نحسب الزاوية مع القطب (Polar angle) -> تعطينا v.

المعادلات (تقريبية):
u = 0.5 + atan2(z, x) / (2 * PI)
v = 0.5 - asin(y) / PI

#### 2. المستوى (Planar Mapping)
نحدد محورين متعامدين على سطح المستوى (u_axis و v_axis).
نسقط النقطة P على هذين المحورين باستخدام الضرب النقطي.
u = (P - Center) * u_axis
v = (P - Center) * v_axis
عادة نأخذ باقي القسمة أو نستخدم دالة تكرار (Repeat) لأن المستوى لا نهائي.

#### 3. الأسطوانة (Cylindrical Mapping)
- **الجسم:** مشابه للكرة بالنسبة لـ u (الزاوية حول المحور). أما v فهو ببساطة الارتفاع النسبي للنقطة على المحور.
- **الأغطية:** تعامل معاملة المستوى (Planar Projection).

### رقعة الشطرنج (Checkerboard)
بمجرد حصولنا على (u, v)، يمكننا عمل نمط شطرنج رياضياً دون صورة:
```c
int check = floor(u * size) + floor(v * size);
if (check % 2 == 0) return WHITE;
else return BLACK;
```

---

## 6. الـ Bump Mapping (تضاريس السطح)

الـ Bump Mapping يعطي إيحاءً بالعمق والخشونة دون تغيير هندسة الشكل فعلياً.

**كيف يعمل؟**
1. نستخدم صورة "خريطة الارتفاع" (Height Map) حيث الأبيض مرتفع والأسود منخفض.
2. عند كل نقطة، نحسب "الميل" (Gradient) في الصورة عند (u, v).
3. نقوم بـ "إمالة" المتجه العمودي الأصلي (Normal) بناءً على هذا الميل.
4. نستخدم العمودي الجديد في حسابات الإضاءة.

النتيجة: الضوء ينعكس وكأن السطح متعرج، مما يخلق ظلالاً ولمعاناً واقعياً جداً.

**الخوارزمية (Perturb Normal):**
1. احسب المشتقات الجزئية للارتفاع بالنسبة لـ u و v (الفرق بين البكسل وجاره).
2. كوّن نظام إحداثيات محلي (Tangent Space) باستخدام العمودي (N) والمتماس (T) والمتماس الثاني (B).
3. اجمع المتجهات:
NewNormal = N + (T * Delta_u) + (B * Delta_v)
4. قم بتوحيد المتجه الجديد (Normalize).

---

## 7. خوارزمية البرنامج الرئيسية (Main Loop)

```text
لكل بكسل (y) في الارتفاع:
  لكل بكسل (x) في العرض:
    1. أنشئ شعاعاً من الكاميرا يمر عبر (x, y).
    2. ابحث عن أقرب تقاطع (t_min) مع جميع كائنات المشهد.
    3. إذا لم يوجد تقاطع -> ارسم لون الخلفية (أو الأسود).
    4. إذا وجد تقاطع:
       أ. احسب نقطة التقاطع (P).
       ب. احسب العمودي (Normal) عند P.
       ج. احسب إحداثيات (u, v).
       د. طبق Bump Mapping لتعديل العمودي (إذا وجد).
       هـ. احسب اللون الأساسي (من الصورة أو اللون الثابت).
       و. احسب الإضاءة (Ambient + Diffuse + Specular).
       ز. تحقق من الظلال (Shadow Rays).
       ح. ادمج الألوان وضع النتيجة في البكسل.
```

---

## نصائح للمبتدئين في هذا المشروع

1. **ابدأ بالبسيط:** ارسم كرة بلون واحد وبدون إضاءة.
2. **المتجهات هي صديقك:** تأكد من أن دوال vec_dot, vec_cross, vec_normalize تعمل بشكل صحيح 100%، أي خطأ فيها سيدمر كل شيء.
3. **تطبيع المتجهات (Normalization):** دائماً قم بتوحيد متجهات الاتجاه والعمودي. نسيان هذا هو سبب 90% من مشاكل الإضاءة.
4. **الـ Epsilon:** عند مقارنة الأعداد العشرية (float/double)، لا تستخدم ==. وعند حساب الظلال، ابدأ الشعاع بعيداً قليلاً عن السطح (P + Normal * EPSILON) لتجنب "حب الشباب" (Shadow Acne) حيث يظلل الجسم نفسه خطأً.
